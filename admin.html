<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="adminBackend">後台管理</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* The body padding-top is inherited from styles.css */
        .admin-container {
            max-width: 800px;
            margin: 25px auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #1a1a1a;
        }

        p {
            line-height: 1.6;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        #import-btn {
            background-color: #28a745;
        }

        #import-btn:hover {
            background-color: #218838;
        }

        input[type="file"] {
            display: block;
            margin: 10px 0;
        }

        #status {
            margin-top: 15px;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
        }

        .status-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        hr {
            margin: 2rem 0;
            border: 0;
            border-top: 1px solid #eee;
        }

        .admin-button.back-button {
            background-color: #42b983;
        }

        .admin-button.back-button:hover {
            background-color: #36a476;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <header-component page-type="admin"></header-component>


        <div class="admin-container">
            <h1 data-i18n="dataManagement">{{ $t('dataManagement') }}</h1>

            <section>
                <h2>{{ $t('exportData') }}</h2>
                <p data-i18n="exportDataDescription">{{ $t('exportDataDescription') }}</p>
                <button id="export-btn" @click="exportAllData">匯出所有資料</button>
            </section>

            <hr>

            <section>
                <h2>匯入資料</h2>
                <p data-i18n="importDataDescription">從 JSON 備份檔案匯入資料。<strong>警告：</strong>
                    這將會清除目前資料庫中的所有資料，並用檔案中的資料完全取代。此操作無法復原。</p>

                <input type="file" id="import-file" accept=".json" ref="importFile">
                <button id="import-btn" @click="importAllData">{{ $t('importData') }}</button>
                <div id="status"></div>
            </section>

        </div>
        <div v-if="notification.show" class="modal-overlay" style="z-index: 9999;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ notification.title }}</h2>
                </div>
                <div class="modal-body">
                    <p>{{ notification.message }}</p>
                </div>
                <div class="modal-footer">
                    <button v-if="notification.type === 'confirm'" @click="handleConfirmation(true)">{{
                        $t('confirm')
                        }}</button>
                    <button @click="handleConfirmation(false)"
                        :class="{ 'remove-btn': notification.type === 'confirm' }">{{
                        notification.type === 'confirm' ? $t('cancel') : $t('close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-i18n@9/dist/vue-i18n.global.js"></script>
    <script src="i18n.js"></script>
    <script src="header-component.js"></script>
    <script>
        const { createApp } = Vue;
        const { createI18n } = VueI18n;

        const i18n = createI18n({
            locale: 'zh-TW', // Default locale
            fallbackLocale: 'en-US', // Fallback locale
            messages, // From i18n.js
        });

        const app = createApp({
            data() {
                return {
                    db: null,
                    notification: {
                        show: false,
                        type: 'alert', // 'alert' or 'confirm'
                        title: '',
                        message: '',
                        onConfirm: null
                    },
                };
            },
            methods: {
                showAlert(message, title = 'Info') {
                    this.notification.type = 'alert';
                    this.notification.title = title;
                    this.notification.message = message;
                    this.notification.show = true;
                },
                showConfirm(message, title = 'Confirm') {
                    return new Promise((resolve) => {
                        this.notification.type = 'confirm';
                        this.notification.title = title;
                        this.notification.message = message;
                        this.notification.show = true;
                        this.notification.onConfirm = resolve;
                    });
                },
                handleConfirmation(isConfirmed) {
                    if (this.notification.onConfirm) {
                        this.notification.onConfirm(isConfirmed);
                    }
                    this.notification.show = false;
                    this.notification.onConfirm = null; // Reset for next time
                },
                async setupDatabase() {
                    this.db = new Dexie('ShoppingCartDB');
                    this.db.version(5).stores({
                        products: 'id, name, price, stock, brand, rating, images, deleted',
                        cart: '++id, &productId, name, price, quantity',
                        orders: '++id, orderId, total, paymentMethod, timestamp, deliveryStatus, deliveryHistory',
                        stockHistory: '++id, productId, timestamp, oldStock, newStock, reason',
                        carouselImages: '++id, &url',
                        reviews: '++id, [orderId+productId], productId, rating, comment, timestamp'
                    });
                    await this.db.open();
                },
                async exportAllData() {
                    try {
                        const data = {};
                        for (const table of this.db.tables) {
                            data[table.name] = await table.toArray();
                        }

                        const json = JSON.stringify(data, null, 2);
                        const blob = new Blob([json], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);

                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'shoppingcart_backup.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        this.showAlert(this.$t('exportSuccess'), this.$t('success'));
                    } catch (error) {
                        console.error('Export failed:', error);
                        this.showAlert(this.$t('exportFailed') + error.message, this.$t('error'));
                    }
                },
                async importAllData() {
                    const fileInput = this.$refs.importFile;
                    const file = fileInput.files[0];

                    if (!file) {
                        this.showAlert(this.$t('noFileSelected'), this.$t('warning'));
                        return;
                    }

                    const confirmImport = await this.showConfirm(
                        this.$t('importWarning'),
                        this.$t('confirmImport')
                    );

                    if (!confirmImport) {
                        this.showAlert(this.$t('importCancelled'), this.$t('info'));
                        return;
                    }

                    try {
                        const importedData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    resolve(JSON.parse(event.target.result));
                                } catch (e) {
                                    reject(new Error(this.$t('fileReadError') + ': ' + e.message));
                                }
                            };
                            reader.onerror = () => {
                                reject(new Error(this.$t('fileReadError')));
                            };
                            reader.readAsText(file);
                        });

                        
                        await this.db.transaction('rw', this.db.tables.map(t => t.name), async (tx) => {
                            for (const table of this.db.tables) {
                                const data = importedData[table.name];
                                if (Array.isArray(data)) {
                                    const tbl = tx.table(table.name); // 確保從交易上下文取表
                                    await tbl.clear();
                                    await tbl.bulkAdd(data);
                                }
                            }
                        });

                        this.showAlert(this.$t('importSuccess'), this.$t('success'));
                    } catch (error) {
                        console.error('Import failed:', error);
                        this.showAlert(this.$t('importFailed') + ': ' + error.message, this.$t('error'));
                    }
                }
            },
            async created() {
                await this.setupDatabase();
            }
        });

        app.use(i18n);
        app.config.globalProperties.$i18n = i18n;
        app.component('header-component', headerComponent);
        const mountedApp = app.mount('#app');

    </script>
</body>

</html>