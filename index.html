<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Shopping Cart with IndexedDB</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="app">

        <header class="app-header-fixed">
            <div class="app-header-content">
                <h1>{{ $t('shopName') }}</h1>
                <div class="language-selector">
                    <label for="language-select">{{ $t('language') }}: </label>
                    <select id="language-select" v-model="locale" @change="$i18n.locale = locale">
                        <option value="zh-TW">繁體中文</option>
                        <option value="zh-CN">简体中文</option>
                        <option value="ja">日本語</option>
                        <option value="ko">한국어</option>
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                    </select>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div v-if="isLoading || isProcessingOrder" class="loading-overlay">
                <div class="spinner"></div>
            </div>

            <!-- Carousel -->
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" v-for="(image, index) in carouselImages" :key="index">
                        <img :src="image.url" class="carousel-image">
                    </div>
                </div>
                <!-- Add Pagination -->
                <div class="swiper-pagination"></div>
                <!-- Add Navigation -->
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>

            <div class="container">
                <div class="products">
                    <div class="products-main-header">
                        <h2>{{ $t('productList') }}</h2>
                        <div class="products-main-header-buttons">
                            <button @click="openModal('orderHistory')">{{ $t('viewOrderHistory') }}</button>
                            <button @click="openModal('productManagement')">{{
                                $t('productManagement') }}</button>
                            <button @click="openModal('carouselManagement')">{{
                                $t('manageCarousel') }}</button>
                        </div>
                    </div>

                    <div class="products-list">
                        <div v-for="product in filteredProducts" :key="product.id" class="product-card"
                            :class="{ deleted: product.deleted }">
                            <div class="product-header">
                                <h3>{{ product.name }}</h3>
                            </div>
                            <p>{{ $t('price') }}: {{ formattedPrice(product.price) }}</p>
                            <p>{{ $t('stock') }}: {{ product.stock }}</p>
                            <p>{{ $t('sold') }}: {{ product.soldQuantity }}</p>
                            <button @click="addToCart(product)" :disabled="product.stock === 0" class="add-to-cart-btn">
                                <i class="material-icons">add_shopping_cart</i>
                                <span>{{ $t('addToCart') }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="cart">
                    <h2>{{ $t('cart') }}</h2>
                    <button v-if="cart.length > 0" @click="clearCart" class="remove-btn clear-cart-btn">{{
                        $t('clearCart') }}</button>
                    <div v-if="isAddingToEmptyCart" class="loading-overlay cart-loading-overlay">
                        <div class="spinner cart-spinner"></div>
                    </div>
                    <div v-if="cart.length === 0" class="empty-cart cart-content">
                        {{ $t('cartEmpty') }}
                    </div>
                    <div v-else class="cart-content">
                        <div class="cart-items-container">
                            <div v-for="item in cart" :key="item.id" class="cart-item">
                                <div>
                                    <strong>{{ item.name }}</strong>
                                    <br>
                                    <br>
                                    <small>{{ formattedPrice(item.price) }}</small>
                                </div>
                                <div class="quantity-controls">
                                    <button @click="updateQuantity(item, -1)">-</button>
                                    <span>{{ item.quantity }}</span>
                                    <button @click="updateQuantity(item, 1)">+</button>
                                </div>
                                <div>
                                    <button @click="removeFromCart(item.id)" class="icon-button remove-btn">
                                        <i class="material-icons">delete</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="cart-summary">
                            <div class="cart-summary-row">
                                <span>{{ $t('totalQuantity') }}:</span>
                                <span>{{ totalQuantity }}</span>
                            </div>
                            <div class="cart-summary-row">
                                <span>{{ $t('total') }}</span>
                                <span>{{ formattedPrice(cartTotal) }}</span>
                            </div>
                            <button @click="startCheckout" :disabled="cart.length === 0" class="checkout-btn">{{
                                $t('checkout') }}</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'checkout'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('checkout') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h3>{{ $t('checkoutSummary') }}</h3>
                        <ul>
                            <li v-for="item in cart" :key="item.id">
                                {{ item.name }} x {{ item.quantity }} - {{ formattedPrice(item.price * item.quantity) }}
                            </li>
                        </ul>
                        <p><strong>{{ $t('total') }}: {{ formattedPrice(cartTotal) }}</strong></p>

                        <h3>{{ $t('choosePaymentMethod') }}</h3>
                        <div class="payment-methods">
                            <label class="payment-method-label">
                                <input type="radio" v-model="paymentMethod" value="credit_card"> {{ $t('creditCard') }}
                            </label>
                            <label class="payment-method-label">
                                <input type="radio" v-model="paymentMethod" value="line_pay"> {{ $t('linePay') }}
                            </label>
                            <label>
                                <input type="radio" v-model="paymentMethod" value="cash"> {{ $t('cash') }}
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="processCheckout">{{ $t('confirmCheckout') }}</button>
                        <button @click="closeModal()" class="remove-btn">{{ $t('cancel') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'orderConfirmation'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('orderCreated') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>{{ $t('orderId') }}: <strong>{{ orderConfirmation.orderId }}</strong></p>
                        <p>{{ $t('total') }}: <strong>{{ formattedPrice(orderConfirmation.total) }}</strong></p>
                        <p>{{ $t('paymentMethod') }}: <strong>{{ $t(orderConfirmation.paymentMethod) }}</strong></p>
                        <h3>{{ $t('orderDetails') }}:</h3>
                        <ul>
                            <li v-for="item in orderConfirmation.items" :key="item.id">
                                {{ item.name }} x {{ item.quantity }} - {{ formattedPrice(item.price * item.quantity) }}
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal()">{{ $t('close') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'orderHistory'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('orderHistory') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div v-if="orderHistory.length === 0" class="modal-body">
                        <p>{{ $t('noOrderHistory') }}</p>
                    </div>
                    <div v-else class="modal-body">
                        <div v-for="order in orderHistory" :key="order.orderId" class="order-history-card">
                            <h3>{{ $t('orderId') }}: {{ order.orderId }}</h3>
                            <p>{{ $t('date') }}: {{ new Date(order.timestamp).toLocaleString() }}</p>
                            <p>{{ $t('total') }}: {{ formattedPrice(order.total) }}</p>
                            <p>{{ $t('paymentMethod') }}: {{ $t(order.paymentMethod) }}</p>
                            <h4>{{ $t('orderDetails') }}:</h4>
                            <ul>
                                <li v-for="item in order.items" :key="item.id">
                                    {{ item.name }} x {{ item.quantity }} - {{ formattedPrice(item.price *
                                    item.quantity) }}
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal()" class="remove-btn">{{ $t('closeOrderHistory') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'editStock'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('editStock') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>{{ $t('productName') }}: <strong>{{ currentModal.data.name }}</strong></p>
                        <div class="form-group">
                            <label for="new-stock">{{ $t('newStock') }}: </label>
                            <input type="number" id="new-stock" v-model.number="currentModal.data.newStock" min="0"
                                class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="stock-reason">{{ $t('reason') }}: </label>
                            <input type="text" id="stock-reason" v-model="currentModal.data.stockChangeReason"
                                :placeholder="$t('stockChangeReason')" class="form-input form-input-wide">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="confirmEditStock">{{ $t('confirm') }}</button>
                        <button @click="closeModal()" class="remove-btn">{{ $t('cancel') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'stockHistory'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('stockHistory') }} <span v-if="currentModal.data.product">- {{
                                currentModal.data.product.name }}</span></h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div v-if="stockHistory.length === 0" class="modal-body">
                        <p>{{ $t('noStockHistory') }}</p>
                    </div>
                    <div v-else class="modal-body">
                        <div v-for="entry in stockHistory" :key="entry.id" class="stock-history-card">
                            <p><strong>{{ $t('date') }}:</strong> {{ new Date(entry.timestamp).toLocaleString() }}</p>
                            <p><strong>{{ $t('reason') }}:</strong> {{ entry.reason }}</p>
                            <p><strong>{{ $t('stock') }}:</strong> {{ entry.oldStock }} -> {{ entry.newStock }}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal()" class="remove-btn">{{ $t('close') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'productManagement'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('productManagement') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="add-product-section">
                            <h3>{{ $t('addProduct') }}</h3>
                            <div class="form-group-inline">
                                <input type="text" v-model="newProductName" :placeholder="$t('productName')"
                                    class="form-input">
                                <input type="number" v-model.number="newProductPrice" :placeholder="$t('price')"
                                    class="form-input">
                                <input type="number" v-model.number="newProductStock" :placeholder="$t('stock')"
                                    class="form-input">
                                <button @click="addNewProduct">{{ $t('addProduct') }}</button>
                            </div>
                        </div>
                        <div class="products-list">
                            <div v-for="product in productsWithSoldQuantity" :key="product.id" class="product-card"
                                :class="{ deleted: product.deleted }">
                                <div class="product-header">
                                    <h3>{{ product.name }}</h3>
                                    <div class="product-actions dropdown">
                                        <button class="icon-button dropbtn">
                                            <i class="material-icons">more_vert</i>
                                        </button>
                                        <div class="dropdown-content">
                                            <a href="#"
                                                @click.prevent="openModal('editStock', { product: product, newStock: product.stock, stockChangeReason: '' })"><i
                                                    class="material-icons">edit</i> {{ $t('editStock') }}</a>
                                            <a href="#" @click.prevent="viewStockHistory(product)"><i
                                                    class="material-icons">history</i> {{ $t('viewHistory') }}</a>
                                            <a v-if="!product.deleted" href="#"
                                                @click.prevent="deleteProduct(product)"><i
                                                    class="material-icons">delete</i> {{ $t('deleteProduct') }}</a>
                                            <a v-if="product.deleted" href="#"
                                                @click.prevent="restoreProduct(product)"><i
                                                    class="material-icons">restore</i> {{ $t('restore') }}</a>
                                        </div>
                                    </div>
                                </div>
                                <p>{{ $t('price') }}: {{ formattedPrice(product.price) }}</p>
                                <p>{{ $t('stock') }}: {{ product.stock }}</p>
                                <p>{{ $t('sold') }}: {{ product.soldQuantity }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal()" class="remove-btn">{{ $t('closeProductManagement') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentModal && currentModal.name === 'carouselManagement'" class="modal-overlay"
                :style="{ zIndex: getModalZIndex(modalStack.indexOf(currentModal)) }">
                <div class="modal-content">
                    <div class="modal-header">
                        <button @click="closeModal()" class="close-button" v-if="modalStack.length > 1"><i
                                class="material-icons">arrow_back</i></button>
                        <h2>{{ $t('manageCarousel') }}</h2>
                        <button @click="closeModal()" class="close-button">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="add-image-section">
                            <h3>{{ $t('addImage') }}</h3>
                            <div class="form-group-inline">
                                <input type="text" v-model="newImageUrl" :placeholder="$t('imageUrl')"
                                    class="form-input form-input-wide">
                                <button @click="addCarouselImage">{{ $t('addImage') }}</button>
                            </div>
                        </div>
                        <div class="images-list">
                            <div v-for="(image, index) in carouselImages" :key="index" class="image-card">
                                <img :src="image.url" class="image-card-preview">
                                <button @click="removeCarouselImage(image)" class="remove-btn"><i
                                        class="material-icons">delete</i></button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal()" class="remove-btn">{{ $t('close') }}</button>
                    </div>
                </div>
            </div>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Dexie.js (for IndexedDB) CDN -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- Vue I18n CDN -->
    <script src="https://unpkg.com/vue-i18n@9/dist/vue-i18n.global.js"></script>
    <!-- I18n Messages -->
    <script src="i18n.js"></script>

    <script>
        const { createApp, reactive } = Vue;
        const { createI18n } = VueI18n;

        // Define messages as a reactive object globally
        const reactiveMessages = reactive({
            'zh-TW': {
                shopName: '我的商店',
                viewOrderHistory: '查看歷史訂單',
                productList: '商品列表',
                addProduct: '新增商品',
                productName: '商品名稱',
                price: '價格',
                addToCart: '加入購物車',
                stock: '庫存',
                sold: '已售出',
                cart: '購物車',
                clearCart: '清空購物車',
                cartEmpty: '購物車是空的',
                total: '總計',
                totalQuantity: '總數量',
                checkout: '結帳',
                checkoutSummary: '訂單摘要',
                choosePaymentMethod: '選擇支付方式',
                creditCard: '信用卡',
                linePay: 'Line Pay',
                cash: '現金',
                confirmCheckout: '確認結帳',
                cancel: '取消',
                orderCreated: '訂單成立！',
                orderId: '訂單編號',
                paymentMethod: '支付方式',
                orderDetails: '訂單詳情',
                close: '關閉',
                orderHistory: '歷史訂單',
                noOrderHistory: '目前沒有歷史訂單。',
                date: '日期',
                productSoldOut: '該商品已售罄！',
                maxQuantityReached: '已達到該商品的最大購買數量！',
                enterValidProduct: '請輸入有效的商品名稱和價格。',
                cartEmptyCheckout: '購物車是空的，無法結帳。',
                selectPaymentMethod: '請選擇支付方式。',
                checkoutSuccess: '結帳成功！',
                checkoutFailed: '結帳失敗，請稍後再試。',
                closeOrderHistory: '關閉歷史訂單',
                language: '語言',
                remove: '移除',
                editQuantity: '修改數量',
                currentQuantity: '目前數量',
                newQuantity: '新數量',
                confirm: '確認',
                invalidQuantity: '數量無效！',
                updateQuantityFailed: '更新數量失敗！',
                currencySymbol: 'NT$',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 1,
                editStock: '修改庫存',
                newStock: '新庫存',
                invalidStock: '庫存無效！',
                insufficientStock: '庫存不足，無法結帳。商品: {productName}, 庫存: {stock}, 需求: {quantity}',
                viewHistory: '查看歷史異動',
                stockHistory: '庫存歷史異動',
                reason: '原因',
                noStockHistory: '沒有庫存異動記錄。',
                stockChangeReason: '庫存調整原因',
                reasonRequired: '必須填寫原因。',
                deleteProduct: '刪除商品',
                deleteConfirmation: '您確定要刪除商品 {productName} 嗎？此操作無法復原。',
                showAllProducts: '顯示所有商品',
                restore: '還原',
                productManagement: '商品管理',
                closeProductManagement: '關閉商品管理',
                manageCarousel: '管理輪播',
                addImage: '新增圖片',
                imageUrl: '圖片網址',
                imageExists: '該圖片網址已存在。',
                dbErrorReverted: '資料庫操作失敗，已還原變更。',
                back: '返回'
            },
            'zh-CN': {
                shopName: '我的商店',
                viewOrderHistory: '查看历史订单',
                productList: '商品列表',
                addProduct: '新增商品',
                productName: '商品名称',
                price: '价格',
                addToCart: '加入购物车',
                stock: '库存',
                sold: '已售出',
                cart: '购物车',
                clearCart: '清空购物车',
                cartEmpty: '购物车是空的',
                total: '总计',
                totalQuantity: '总数量',
                checkout: '结账',
                checkoutSummary: '订单摘要',
                choosePaymentMethod: '选择支付方式',
                creditCard: '信用卡',
                linePay: 'Line Pay',
                cash: '现金',
                confirmCheckout: '确认结账',
                cancel: '取消',
                orderCreated: '订单成立！',
                orderId: '订单编号',
                paymentMethod: '支付方式',
                orderDetails: '订单详情',
                close: '关闭',
                orderHistory: '历史订单',
                noOrderHistory: '目前没有历史订单。',
                date: '日期',
                productSoldOut: '该商品已售罄！',
                maxQuantityReached: '已达到该商品的最大购买数量！',
                enterValidProduct: '请输入有效的商品名称和价格。',
                cartEmptyCheckout: '购物车是空的，无法结账。',
                selectPaymentMethod: '请选择支付方式。',
                checkoutSuccess: '结账成功！',
                checkoutFailed: '结账失败，请稍后再试。',
                closeOrderHistory: '关闭历史订单',
                language: '语言',
                remove: '移除',
                editQuantity: '修改数量',
                currentQuantity: '目前数量',
                newQuantity: '新数量',
                confirm: '确认',
                invalidQuantity: '数量无效！',
                updateQuantityFailed: '更新数量失败！',
                currencySymbol: '¥',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 0.23,
                editStock: '修改库存',
                newStock: '新库存',
                invalidStock: '库存无效！',
                insufficientStock: '库存不足，无法结账。商品: {productName}, 库存: {stock}, 需求: {quantity}',
                viewHistory: '查看历史异动',
                stockHistory: '库存历史异动',
                reason: '原因',
                noStockHistory: '没有库存异动记录。',
                stockChangeReason: '库存调整原因',
                reasonRequired: '必须填写原因。',
                deleteProduct: '删除商品',
                deleteConfirmation: '您确定要删除商品 {productName} 吗？此操作无法复原。',
                showAllProducts: '显示所有商品',
                restore: '还原',
                productManagement: '商品管理',
                closeProductManagement: '关闭商品管理',
                manageCarousel: '管理轮播',
                addImage: '新增图片',
                imageUrl: '图片网址',
                imageExists: '該图片网址已存在。',
                dbErrorReverted: '数据库操作失败，已还原变更。',
                back: '返回'
            },
            'ja': {
                shopName: '私の店',
                viewOrderHistory: '注文履歴を見る',
                productList: '商品リスト',
                addProduct: '商品を追加',
                productName: '商品名',
                price: '価格',
                addToCart: 'カートに追加',
                stock: '在庫',
                sold: '販売済み',
                cart: 'カート',
                clearCart: 'カートを空にする',
                cartEmpty: 'カートは空です',
                total: '合計',
                totalQuantity: '合計数量',
                checkout: 'チェックアウト',
                checkoutSummary: '注文概要',
                choosePaymentMethod: '支払い方法を選択',
                creditCard: 'クレジットカード',
                linePay: 'Line Pay',
                cash: '現金',
                confirmCheckout: 'チェックアウトを確認',
                cancel: 'キャンセル',
                orderCreated: '注文が作成されました！',
                orderId: '注文ID',
                paymentMethod: '支払い方法',
                orderDetails: '注文詳細',
                close: '閉じる',
                orderHistory: '注文履歴',
                noOrderHistory: '注文履歴はありません。',
                date: '日付',
                productSoldOut: 'この商品は売り切れです！',
                maxQuantityReached: 'この商品の最大購入数に達しました！',
                enterValidProduct: '有効な商品名と価格を入力してください。',
                cartEmptyCheckout: 'カートは空です。チェックアウトできません。',
                selectPaymentMethod: '支払い方法を選択してください。',
                checkoutSuccess: 'チェックアウト成功！',
                checkoutFailed: 'チェックアウトに失敗しました。後でもう一度お試しください。',
                closeOrderHistory: '注文履歴を閉じる',
                language: '言語',
                remove: '削除',
                editQuantity: '数量を編集',
                currentQuantity: '現在の数量',
                newQuantity: '新しい数量',
                confirm: '確認',
                invalidQuantity: '無効な数量！',
                updateQuantityFailed: '数量の更新に失敗しました！',
                currencySymbol: '¥',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 3.8,
                editStock: '在庫を編集',
                newStock: '新しい在庫',
                invalidStock: '無効な在庫！',
                insufficientStock: '在庫が不足しているため、チェックアウトできません。商品: {productName}, 在庫: {stock}, 要求: {quantity}',
                viewHistory: '履歴を見る',
                stockHistory: '在庫履歴',
                reason: '理由',
                noStockHistory: '在庫履歴はありません。',
                stockChangeReason: '在庫調整理由',
                reasonRequired: '理由が必要です。',
                deleteProduct: '商品を削除',
                deleteConfirmation: '商品 {productName} を削除してもよろしいですか？この操作は元に戻せません。',
                showAllProducts: 'すべての商品を表示',
                restore: '復元',
                productManagement: '商品管理',
                closeProductManagement: '商品管理を閉じる',
                manageCarousel: '管理輪播',
                addImage: '画像を追加',
                imageUrl: '画像URL',
                imageExists: 'この画像URLはすでに存在します。',
                dbErrorReverted: 'データベース操作が失敗しました。変更は元に戻されました。',
                back: '戻る'
            },
            'ko': {
                shopName: '내 상점',
                viewOrderHistory: '주문 내역 보기',
                productList: '상품 목록',
                addProduct: '상품 추가',
                productName: '상품명',
                price: '가격',
                addToCart: '장바구니에 추가',
                stock: '재고',
                sold: '판매됨',
                cart: '장바구니',
                clearCart: '장바구니 비우기',
                cartEmpty: '장바구니가 비어 있습니다',
                total: '총계',
                totalQuantity: '총 수량',
                checkout: '결제',
                checkoutSummary: '주문 요약',
                choosePaymentMethod: '결제 방법 선택',
                creditCard: '신용 카드',
                linePay: '라인 페이',
                cash: '현금',
                confirmCheckout: '결제 확인',
                cancel: '취소',
                orderCreated: '주문이 생성되었습니다!',
                orderId: '주문 ID',
                paymentMethod: '결제 방법',
                orderDetails: '주문 세부 정보',
                close: '닫기',
                orderHistory: '주문 내역',
                noOrderHistory: '주문 내역이 없습니다.',
                date: '날짜',
                productSoldOut: '이 상품은 품절되었습니다!',
                maxQuantityReached: '이 상품의 최대 구매 수량에 도달했습니다!',
                enterValidProduct: '유효한 상품명과 가격을 입력하세요.',
                cartEmptyCheckout: '장바구니가 비어 있습니다. 결제할 수 없습니다.',
                selectPaymentMethod: '결제 방법을 선택하세요.',
                checkoutSuccess: '결제 성공!',
                checkoutFailed: '결제 실패. 나중에 다시 시도하십시오.',
                closeOrderHistory: '주문 내역 닫기',
                language: '언어',
                remove: '제거',
                editQuantity: '수량 수정',
                currentQuantity: '현재 수량',
                newQuantity: '새 수량',
                confirm: '확인',
                invalidQuantity: '유효하지 않은 수량!',
                updateQuantityFailed: '수량 업데이트 실패!',
                currencySymbol: '₩',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 40,
                editStock: '재고 수정',
                newStock: '새 재고',
                invalidStock: '잘못된 재고!',
                insufficientStock: '재고가 부족하여 결제할 수 없습니다. 제품: {productName}, 재고: {stock}, 필요 수량: {quantity}',
                viewHistory: '기록 보기',
                stockHistory: '재고 기록',
                reason: '사유',
                noStockHistory: '재고 변경 기록이 없습니다.',
                stockChangeReason: '재고 조정 사유',
                reasonRequired: '사유는 필수입니다.',
                deleteProduct: '상품 삭제',
                deleteConfirmation: '상품 {productName}을(를) 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.',
                showAllProducts: '모든 상품 보기',
                restore: '복원',
                productManagement: '상품 관리',
                closeProductManagement: '상품 관리 닫기',
                manageCarousel: '캐러셀 관리',
                addImage: '이미지 추가',
                imageUrl: '이미지 URL',
                imageExists: '이미지 URL이 이미 존재합니다.',
                dbErrorReverted: '데이터베이스 작업 실패, 변경 사항이 되돌려졌습니다.',
                back: '뒤로'
            },
            'en-US': {
                shopName: 'My Shop',
                viewOrderHistory: 'View Order History',
                productList: 'Product List',
                addProduct: 'Add Product',
                productName: 'Product Name',
                price: 'Price',
                addToCart: 'Add to Cart',
                stock: 'Stock',
                sold: 'Sold',
                cart: 'Cart',
                clearCart: 'Clear Cart',
                cartEmpty: 'Cart is empty',
                total: 'Total',
                totalQuantity: 'Total Quantity',
                checkout: 'Checkout',
                checkoutSummary: 'Order Summary',
                choosePaymentMethod: 'Choose Payment Method',
                creditCard: 'Credit Card',
                linePay: 'Line Pay',
                cash: 'Cash',
                confirmCheckout: 'Confirm Checkout',
                cancel: 'Cancel',
                orderCreated: 'Order Created!',
                orderId: 'Order ID',
                paymentMethod: 'Payment Method',
                orderDetails: 'Order Details',
                close: 'Close',
                orderHistory: 'Order History',
                noOrderHistory: 'No order history available.',
                date: 'Date',
                productSoldOut: 'This product is sold out!',
                maxQuantityReached: 'Maximum quantity for this product reached!',
                enterValidProduct: 'Please enter a valid product name and price.',
                cartEmptyCheckout: 'Cart is empty, cannot checkout.',
                selectPaymentMethod: 'Please select a payment method.',
                checkoutSuccess: 'Checkout successful!',
                checkoutFailed: 'Checkout failed, please try again later.',
                closeOrderHistory: 'Close Order History',
                language: 'Language',
                remove: 'Remove',
                editQuantity: 'Edit Quantity',
                currentQuantity: 'Current Quantity',
                newQuantity: 'New Quantity',
                confirm: 'Confirm',
                invalidQuantity: 'Invalid Quantity!',
                updateQuantityFailed: 'Failed to update quantity!',
                currencySymbol: '$',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 0.032,
                editStock: 'Edit Stock',
                newStock: 'New Stock',
                invalidStock: 'Invalid Stock!',
                insufficientStock: 'Insufficient stock to checkout. Product: {productName}, Stock: {stock}, Requested: {quantity}',
                viewHistory: 'View History',
                stockHistory: 'Stock History',
                reason: 'Reason',
                noStockHistory: 'No stock history available.',
                stockChangeReason: 'Stock adjustment reason',
                reasonRequired: 'Reason is required.',
                deleteProduct: 'Delete Product',
                deleteConfirmation: 'Are you sure you want to delete {productName}? This action cannot be undone.',
                showAllProducts: 'Show All Products',
                restore: 'Restore',
                productManagement: 'Product Management',
                closeProductManagement: 'Close Product Management',
                manageCarousel: 'Manage Carousel',
                addImage: 'Add Image',
                imageUrl: 'Image URL',
                imageExists: 'This image URL already exists.',
                dbErrorReverted: 'Database operation failed, changes reverted.',
                back: 'Back'
            },
            'en-GB': {
                shopName: 'My Shop',
                viewOrderHistory: 'View Order History',
                productList: 'Product List',
                addProduct: 'Add Product',
                productName: 'Product Name',
                price: 'Price',
                addToCart: 'Add to Basket',
                stock: 'Stock',
                sold: 'Sold',
                cart: 'Basket',
                clearCart: 'Clear Basket',
                cartEmpty: 'Basket is empty',
                total: 'Total',
                totalQuantity: 'Total Quantity',
                checkout: 'Checkout',
                checkoutSummary: 'Order Summary',
                choosePaymentMethod: 'Choose Payment Method',
                creditCard: 'Credit Card',
                linePay: 'Line Pay',
                cash: 'Cash',
                confirmCheckout: 'Confirm Checkout',
                cancel: 'Cancel',
                orderCreated: 'Order Created!',
                orderId: 'Order ID',
                paymentMethod: 'Payment Method',
                orderDetails: 'Order Details',
                close: 'Close',
                orderHistory: 'Order History',
                noOrderHistory: 'No order history available.',
                date: 'Date',
                productSoldOut: 'This product is sold out!',
                maxQuantityReached: 'Maximum quantity for this product reached!',
                enterValidProduct: 'Please enter a valid product name and price.',
                cartEmptyCheckout: 'Basket is empty, cannot checkout.',
                selectPaymentMethod: 'Please select a payment method.',
                checkoutSuccess: 'Checkout successful!',
                checkoutFailed: 'Checkout failed, please try again later.',
                closeOrderHistory: 'Close Order History',
                language: 'Language',
                remove: 'Remove',
                editQuantity: 'Edit Quantity',
                currentQuantity: 'Current Quantity',
                newQuantity: 'New Quantity',
                confirm: 'Confirm',
                invalidQuantity: 'Invalid Quantity!',
                updateQuantityFailed: 'Failed to update quantity!',
                currencySymbol: '£',
                currencyFormat: '{symbol}{value}',
                exchangeRate: 0.025,
                editStock: 'Edit Stock',
                newStock: 'New Stock',
                invalidStock: 'Invalid Stock!',
                insufficientStock: 'Insufficient stock to checkout. Product: {productName}, Stock: {stock}, Requested: {quantity}',
                manageCarousel: 'Manage Carousel'
            }
        });

        const i18n = createI18n({
            locale: 'zh-TW', // 預設語言
            fallbackLocale: 'en-US',
            messages,
        });

        const app = createApp({
            data() {
                return {
                    products: [],
                    cart: [], // 購物車內容
                    db: null,    // IndexedDB instance
                    newProductName: '',
                    newProductPrice: null,
                    newProductStock: 0,
                    paymentMethod: 'credit_card', // 預設支付方式
                    orderConfirmation: null, // 儲存訂單確認資訊
                    orderHistory: [], // 儲存歷史訂單
                    isLoading: true, // 控制初始載入畫面
                    isProcessingOrder: false, // 控制結帳處理載入畫面
                    isAddingToEmptyCart: false, // 控制加入空購物車時的載入畫面
                    locale: 'zh-TW', // 預設語言為繁體中文
                    stockHistory: [],
                    carouselImages: [],
                    newImageUrl: '',
                    modalStack: [] // Centralized modal management
                };
            },
            computed: {
                cartTotal() {
                    return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                },
                totalQuantity() {
                    return this.cart.reduce((total, item) => total + item.quantity, 0);
                },
                productsWithSoldQuantity() {
                    const soldQuantities = {};
                    this.orderHistory.forEach(order => {
                        order.items.forEach(item => {
                            soldQuantities[item.productId] = (soldQuantities[item.productId] || 0) + item.quantity;
                        });
                    });

                    return this.products.map(product => ({
                        ...product,
                        soldQuantity: soldQuantities[product.id] || 0
                    }));
                },
                filteredProducts() {
                    return this.productsWithSoldQuantity.filter(p => !p.deleted);
                },
                currentModal() {
                    return this.modalStack.length > 0 ? this.modalStack[this.modalStack.length - 1] : null;
                },
                showModalOverlay() {
                    return this.modalStack.length > 0;
                }
            },
            methods: {
                openModal(name, data = {}) {
                    this.modalStack.push({ name, data });
                },
                closeModal() {
                    this.modalStack.pop();
                },
                closeAllModals() {
                    this.modalStack = [];
                },
                getModalZIndex(index) {
                    return 1000 + index;
                },
                generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },
                formattedPrice(price) {
                    const locale = this.locale;
                    // Access messages from i18n.global directly, as it's now reactive
                    const localeConfig = i18n.global.messages[locale];

                    if (localeConfig && localeConfig.currencyFormat) {
                        const convertedPrice = price * (localeConfig.exchangeRate || 1);
                        const finalPrice = Number.isInteger(convertedPrice) ? convertedPrice : convertedPrice.toFixed(2);
                        return localeConfig.currencyFormat
                            .replace('{symbol}', localeConfig.currencySymbol || '')
                            .replace('{value}', finalPrice);
                    }
                    return `NT$${price}`;
                },
                async setupDatabase() {
                    this.db = new Dexie('ShoppingCartDB');
                    this.db.version(81).stores({
                        products: 'id, name, price, stock, deleted',
                        cart: '++id, &productId, name, price, quantity',
                        orders: '++id, orderId, total, paymentMethod, timestamp',
                        stockHistory: '++id, productId, timestamp, oldStock, newStock, reason',
                        carouselImages: '++id, &url'
                    });
                },
                async loadProducts() {
                    if (!this.db) return;
                    try {
                        this.products = await this.db.products.toArray();
                    } catch (error) {
                        console.error("Could not load products from IndexedDB:", error);
                    }
                },
                async loadCart() {
                    if (!this.db) return;
                    try {
                        const cartItems = await this.db.cart.toArray();
                        this.cart = cartItems;
                    } catch (error) {
                        console.error("Could not load cart from IndexedDB:", error);
                    }
                },
                async addToCart(product) {
                    if (product.stock === 0) {
                        alert(this.$t('productSoldOut'));
                        return;
                    }

                    const wasCartEmpty = this.cart.length === 0;
                    if (wasCartEmpty) {
                        this.isAddingToEmptyCart = true;
                    }

                    try {
                        await this.db.transaction('rw', this.db.cart, async (trans) => {
                            const cartTable = trans.table('cart');
                            const existingItem = await cartTable.where('productId').equals(product.id).first();

                            if (existingItem) {
                                if (existingItem.quantity >= product.stock) {
                                    alert(this.$t('maxQuantityReached'));
                                    return;
                                }
                                await cartTable.update(existingItem.id, {
                                    quantity: existingItem.quantity + 1
                                });
                            } else {
                                await cartTable.add({
                                    productId: product.id,
                                    name: product.name,
                                    price: product.price,
                                    quantity: 1
                                });
                            }
                        });
                        await this.loadCart();

                        if (wasCartEmpty) {
                            await new Promise(resolve => setTimeout(resolve, 600));
                            this.isAddingToEmptyCart = false;
                        }

                    } catch (error) {
                        if (wasCartEmpty) {
                            this.isAddingToEmptyCart = false;
                        }
                        console.error("Error adding to cart:", error);
                    }
                },
                async removeFromCart(itemId) {
                    try {
                        await this.db.cart.delete(itemId);
                        await this.loadCart();
                    } catch (error) {
                        console.error("Error removing from cart:", error);
                    }
                },
                async updateQuantity(item, change) {
                    try {
                        const productInStock = this.products.find(p => p.id === item.productId);
                        const newQuantity = item.quantity + change;

                        if (change > 0 && productInStock && newQuantity > productInStock.stock) {
                            alert(this.$t('maxQuantityReached'));
                            return;
                        }

                        await this.db.transaction('rw', this.db.cart, async (trans) => {
                            if (newQuantity <= 0) {
                                await trans.cart.delete(item.id);
                            } else {
                                await trans.cart.update(item.id, { quantity: newQuantity });
                            }
                        });
                        await this.loadCart();
                    } catch (error) {
                        console.error("Error updating quantity:", error);
                    }
                },
                async addNewProduct() {
                    if (this.newProductName && this.newProductPrice > 0) {
                        const newProduct = {
                            id: this.generateUUID(),
                            name: this.newProductName,
                            price: parseFloat(this.newProductPrice),
                            stock: this.newProductStock,
                            deleted: false
                        };
                        await this.db.products.add(newProduct);
                        await this.loadProducts();
                        this.newProductName = '';
                        this.newProductPrice = null;
                        this.newProductStock = 0;
                    } else {
                        alert(this.$t('enterValidProduct'));
                    }
                },
                async deleteProduct(product) {
                    if (confirm(this.$t('deleteConfirmation', { productName: product.name }))) {
                        try {
                            await this.db.transaction('rw', this.db.products, this.db.cart, async (trans) => {
                                await trans.products.update(product.id, { deleted: true });
                                await trans.cart.where('productId').equals(product.id).delete();
                            });
                            await this.loadProducts();
                            await this.loadCart();
                        } catch (error) {
                            console.error("Error deleting product:", error);
                            alert("Failed to delete product.");
                        }
                    }
                },
                async restoreProduct(product) {
                    try {
                        await this.db.transaction('rw', this.db.products, async (trans) => {
                            await trans.products.update(product.id, { deleted: false });
                        });
                        await this.loadProducts();
                    } catch (error) {
                        console.error("Error restoring product:", error);
                        alert("Failed to restore product.");
                    }
                },
                async clearCart() {
                    try {
                        await this.db.cart.clear();
                        await this.loadCart();
                    } catch (error) {
                        console.error("Error clearing cart:", error);
                    }
                },
                startCheckout() {
                    this.openModal('checkout');
                },
                async processCheckout() {
                    if (this.cart.length === 0) {
                        alert(this.$t('cartEmptyCheckout'));
                        return;
                    }

                    if (!this.paymentMethod) {
                        alert(this.$t('selectPaymentMethod'));
                        return;
                    }

                    for (const cartItem of this.cart) {
                        const product = this.products.find(p => p.id === cartItem.productId);
                        if (!product || product.stock < cartItem.quantity) {
                            alert(this.$t('insufficientStock', { productName: cartItem.name, stock: product ? product.stock : 0, quantity: cartItem.quantity }));
                            return;
                        }
                    }

                    try {
                        this.isProcessingOrder = true; // 開始處理訂單，顯示載入畫面

                        const orderId = `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                        const order = {
                            orderId: orderId,
                            total: this.cartTotal,
                            paymentMethod: this.paymentMethod,
                            timestamp: new Date().toISOString(),
                            items: this.cart.map(item => ({ ...item })) // 複製購物車商品，避免引用問題
                        };

                        await this.db.transaction('rw', this.db.orders, this.db.products, this.db.cart, this.db.stockHistory, async (trans) => {
                            await trans.orders.add(order);

                            // 減少商品庫存並記錄歷史
                            for (const cartItem of this.cart) {
                                const productInDb = await trans.products.get(cartItem.productId); // Get product from DB within transaction
                                if (productInDb) {
                                    const oldStock = productInDb.stock; // Use stock from DB
                                    const newStock = oldStock - cartItem.quantity;
                                    await trans.products.update(productInDb.id, { stock: newStock });
                                    await trans.stockHistory.add({
                                        productId: productInDb.id,
                                        timestamp: new Date().toISOString(),
                                        oldStock,
                                        newStock,
                                        reason: `Order ${orderId}`
                                    });
                                }
                            }

                            await trans.cart.clear(); // 清空購物車
                        });

                        await this.loadProducts();
                        await this.loadCart();
                        await this.loadOrderHistory();

                        await new Promise(resolve => setTimeout(resolve, 1000));

                        this.isProcessingOrder = false; // 處理完成，關閉載入畫面
                        this.orderConfirmation = order; // 顯示訂單確認資訊
                        this.closeModal(); // Close checkout modal
                        this.openModal('orderConfirmation', order); // Open order confirmation modal
                        alert(this.$t('checkoutSuccess'));

                    } catch (error) {
                        this.isProcessingOrder = false; // 處理失敗，關閉載入畫面
                        console.error("Error processing checkout:", error);
                        alert(this.$t('checkoutFailed'));
                    }
                },
                async toggleOrderHistory() {
                    await this.loadOrderHistory();
                    this.openModal('orderHistory');
                },
                async loadOrderHistory() {
                    if (!this.db) return;
                    try {
                        this.orderHistory = await this.db.orders.toArray();
                        this.orderHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    } catch (error) {
                        console.error("Could not load order history from IndexedDB:", error);
                    }
                },
                startEditStock(product) {
                    this.openModal('editStock', { product: { ...product }, newStock: product.stock, stockChangeReason: '' });
                },
                async confirmEditStock() {
                    const product = this.currentModal.data.product;
                    const newStock = this.currentModal.data.newStock;
                    const stockChangeReason = this.currentModal.data.stockChangeReason;

                    if (newStock < 0) {
                        alert(this.$t('invalidStock'));
                        return;
                    }

                    if (!stockChangeReason) {
                        alert(this.$t('reasonRequired'));
                        return;
                    }

                    try {
                        await this.db.transaction('rw', this.db.products, this.db.stockHistory, async (trans) => {
                            // Fetch the latest stock from the database within the transaction
                            const productInDb = await trans.products.get(product.id);
                            const oldStock = productInDb ? productInDb.stock : product.stock; // Fallback to current modal data if not found

                            await trans.products.update(product.id, { stock: newStock });
                            await trans.stockHistory.add({
                                productId: product.id,
                                timestamp: new Date().toISOString(),
                                oldStock,
                                newStock,
                                reason: stockChangeReason
                            });
                        });
                        await this.loadProducts();
                        this.closeModal();
                    } catch (error) {
                        console.error("Error confirming stock edit:", error);
                        alert("Failed to update stock.");
                    }
                },
                cancelEditStock() {
                    this.closeModal();
                },
                async viewStockHistory(product) {
                    if (!this.db) return;
                    this.stockHistory = []; // Clear previous history
                    try {
                        const history = await this.db.stockHistory.where('productId').equals(product.id).toArray();
                        this.stockHistory = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        this.openModal('stockHistory', { product: product });
                    } catch (error) {
                        console.error("Could not load stock history from IndexedDB:", error);
                    }
                },
                async logStockChange(productId, oldStock, newStock, reason) {
                    if (!this.db) return;
                    try {
                        await this.db.stockHistory.add({
                            productId,
                            timestamp: new Date().toISOString(),
                            oldStock,
                            newStock,
                            reason
                        });
                    } catch (error) {
                        console.error("Error logging stock change:", error);
                    }
                },
                async loadCarouselImages() {
                    if (!this.db) return;
                    try {
                        this.carouselImages = await this.db.carouselImages.toArray();
                        if (this.carouselImages.length === 0) {
                            // Add default images if none exist
                            this.carouselImages = [
                                { url: 'https://via.placeholder.com/1200x300/42b983/FFFFFF?Text=Slide+1' },
                                { url: 'https://via.placeholder.com/1200x300/36a476/FFFFFF?Text=Slide+2' },
                                { url: 'https://via.placeholder.com/1200x300/2c3e50/FFFFFF?Text=Slide+3' }
                            ];
                        }
                    } catch (error) {
                        console.error("Could not load carousel images from IndexedDB:", error);
                    }
                },
                initSwiper() {
                    this.$nextTick(() => {
                        if (this.swiper) {
                            this.swiper.destroy(true, true);
                        }
                        this.swiper = new Swiper('.swiper-container', {
                            loop: true,
                            pagination: {
                                el: '.swiper-pagination',
                                clickable: true,
                            },
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev',
                            },
                            autoplay: {
                                delay: 3000,
                                disableOnInteraction: false,
                            },
                        });
                    });
                },
                async addCarouselImage() {
                    if (!this.newImageUrl) return;

                    const existing = this.carouselImages.some(img => img.url === this.newImageUrl);
                    if (existing) {
                        alert(this.$t('imageExists'));
                        return;
                    }

                    const newImage = { url: this.newImageUrl };
                    const originalUrl = this.newImageUrl;

                    // 1. Optimistic UI Update
                    this.carouselImages.push(newImage);
                    this.newImageUrl = '';
                    this.initSwiper();

                    // 2. Call the dedicated DB method
                    try {
                        await this._dbAddImage(newImage);
                    } catch (error) {
                        console.error("Error adding carousel image to DB:", error);
                        // 3. Revert UI on failure
                        const index = this.carouselImages.findIndex(img => img.url === newImage.url);
                        if (index !== -1) {
                            this.carouselImages.splice(index, 1);
                        }
                        this.newImageUrl = originalUrl;
                        this.initSwiper();
                        alert(this.$t('dbErrorReverted'));
                    }
                },

                async removeCarouselImage(image) {
                    const index = this.carouselImages.findIndex(img => img.url === image.url);
                    if (index === -1) return;

                    try {
                        await this._dbRemoveImage(image.url);

                        // Update UI only after successful DB operation
                        this.carouselImages.splice(index, 1);
                        this.initSwiper();
                    } catch (error) {
                        console.error("Error removing carousel image from DB:", error);
                        alert('Failed to remove image.');
                    }
                },

                // --- Dedicated DB Methods ---
                _dbAddImage(image) {
                    return this.db.transaction('rw', this.db.carouselImages, async (trans) => {
                        const carouselImagesTable = trans.table('carouselImages');
                        await carouselImagesTable.add(image);
                    });


                },
                _dbRemoveImage(url) {
                    return this.db.transaction('rw', this.db.carouselImages, async (trans) => {
                        const carouselImagesTable = trans.table('carouselImages');
                        await carouselImagesTable.where('url').equals(url).delete();
                    });
                },

                async fetchExchangeRates() {
                    const BASE_CURRENCY = 'TWD';
                    const API_URL = `https://h-web-api-a2gvavdbg9dggxa3.canadacentral-01.azurewebsites.net/api/Toolbox/ProxyAPI?Url=https%3A%2F%2Fv6.exchangerate-api.com%2Fv6%2Fa80efb83a09fb6489e1e5034%2Flatest%2F${BASE_CURRENCY}`;

                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        const dataParse = JSON.parse(data.conversion_rates);
                        if (dataParse) {
                            debugger;
                            for (const localeKey in reactiveMessages) { // Use reactiveMessages
                                if (reactiveMessages[localeKey].currencySymbol) { // Use reactiveMessages
                                    const targetCurrency = reactiveMessages[localeKey].currencySymbol.replace(/[^a-zA-Z]/g, ''); // Extract currency code from symbol
                                    if (dataParse[targetCurrency]) {
                                        reactiveMessages[localeKey].exchangeRate = dataParse[targetCurrency]; // Update reactiveMessages
                                    } else {
                                        console.warn(`Exchange rate for ${targetCurrency} not found in API response.`);
                                        reactiveMessages[localeKey].exchangeRate = 1; // Fallback to 1 if not found
                                    }
                                }
                            }
                            console.log("Exchange rates updated successfully!");
                            // No need to re-initialize i18n or set locale messages explicitly here
                            // Vue's reactivity system will handle updates to reactiveMessages
                        } else {
                            console.error("API response does not contain conversion_rates.", data);
                        }
                    } catch (error) {
                        console.error("Failed to fetch exchange rates:", error);
                        // Fallback to default exchange rates (1 for TWD, others as previously defined in i18n.js if not updated)
                        // For simplicity, we'll just log the error. In a real app, you might want to set specific fallbacks.
                    }
                }
            },
            async created() {
                await this.setupDatabase();
                await this.loadProducts();
                await this.loadCart();
                await this.loadOrderHistory();
                await this.loadCarouselImages();
                await this.fetchExchangeRates(); // Fetch exchange rates on app creation
                this.initSwiper();
                this.isLoading = false;
            }
        });

        // Initialize i18n with the reactive messages
        // const i18n = createI18n({
        //     locale: 'zh-TW', // 預設語言
        //     fallbackLocale: 'en-US',
        //     messages: reactiveMessages, // Use the reactive messages object
        // });

        app.use(i18n);
        app.mount('#app');
    </script>

</body>

</html>